var JailCost=Backbone.Model.extend({defaults:{months:[],jails:[],costByMonth:{},maxCost:0},initialize:function(a){_.bindAll(this),this.determineJails(a.data),this.getCostByMonth(a.data,a.months)},determineJails:function(a){this.set("jails",a.groupBy("Jail",["Cost"]).column("Jail").data),this.set("selected-jail",this.get("jails")[0])},getCostByMonth:function(a,b){var c={},d=0,e=this.get("jails");a.addComputedColumn("JailMonth","string",function(a){return a.Month.split(" ")[0]}),_(b).each(function(b){var f=a.rows(function(a){return a.JailMonth==b}),g=0,h=f.groupBy("Jail",["Cost"]),i={};h.each(function(a){var b=a.Cost;g=Math.max(b,g),i[a.Jail]=b}),c[b]=_.map(e,function(a){return{jail:a,cost:i[a]||0}}),d=Math.max(g,d)}),this.set("costByMonth",c),this.set("maxCost",d)},getCostFor:function(a){return this.get("costByMonth")[a]}}),BarKey=Backbone.View.extend({className:"key",initialize:function(a){this.data=a.data,_.bindAll(this)},clear:function(){this.$el.empty()},render:function(){this.size=this.measureDimensions(this.$el),this.scale=this.calculateScale(this.size,this.data),this.clear(),this.redraw()},measureDimensions:function(a){return{width:a.width(),height:a.height()}},calculateScale:function(a,b){return d3.scale.ordinal().rangeBands([0,a.width],.1,0).domain(b)},redraw:function(){function a(){this.append("rect").attr("class",function(a,b){return"square category-"+b}).attr("x",function(a){return d(a)}).attr("y",0).attr("width",e.height).attr("height",e.height)}function b(){this.append("text").attr("class","label").text(function(a){return a}).attr("text-anchor","left").attr("x",function(a){return d(a)+5+e.height}).attr("y",3*e.height/4)}var c=this.data,d=this.scale,e=this.size,f=this.svg=d3.select(this.el).append("svg").attr("width",this.size.width).attr("height",this.size.height).append("g");f.selectAll(".key-item").data(c).enter().append("g").attr("class","key-item").call(a).call(b)}}),Barchart=Backbone.View.extend({initialize:function(a){this.data=a.data,this.labels=a.labels||_.pluck(a.data,"jail"),this.maxCost=a.maxCost||d3.max(_.pluck(a.data,"cost")),_.bindAll(this)},clear:function(){this.$el.empty()},render:function(){this.size=this.measureDimensions(this.$el),this.scales=this.calculateScales(this.size,this.data),this.clear(),this.redraw()},measureDimensions:function(a){var b={},c=$("<span>LABEL TEXT</span>").hide().appendTo(a);return b.width=a.width(),b.height=a.height(),b.labelHeight=c.height(),b.barHeight=b.height-b.labelHeight,b.labelOffset=b.barHeight+b.labelHeight,c.remove(),b},calculateScales:function(a,b){var c={};return c.xAxis=d3.scale.ordinal().rangeBands([0,a.width],.15,0),c.yAxis=d3.scale.linear().range([0,a.barHeight]),c.xAxis.domain(_.pluck(b,"jail")),c.yAxis.domain([0,this.maxCost]),c},redraw:function(){{var a=this.data,b=this.labels,c=this.scales,d=this.size,e=this.svg=d3.select(this.el).append("svg").attr("width",this.size.width).attr("height",this.size.height).append("g").attr("class","chart");d3.svg.axis().scale(c.xAxis).orient("bottom"),d3.svg.axis().scale(c.yAxis).orient("left")}e.selectAll(".bar").data(a).enter().append("rect").attr("class",function(a,b){return"bar category-"+b}).attr("x",function(a){return c.xAxis(a.jail)}).attr("y",function(a){return d.barHeight-c.yAxis(a.cost)}).attr("width",c.xAxis.rangeBand()).attr("height",function(a){return c.yAxis(a.cost)}).append("title").text(function(a){return a.jail+": $"+a.cost}),e.selectAll(".label").data(a).enter().append("text").attr("class","label").text(function(a,c){return b[c]}).attr("text-anchor","middle").attr("x",function(a){return c.xAxis(a.jail)+c.xAxis.rangeBand()/2}).attr("y",d.labelOffset)}}),InteractiveReport=Backbone.View.extend({initialize:function(a){this.model=a.model,this.report=new JailCostReport({model:a.model}),_.bindAll(this)},append:function(a){this.$el.append(a.el),a.parent=this},clear:function(){this.$el.empty()},render:function(){var a=this,b=this.report,c=this.model,d=c.get("months"),e=c.get("selected-jail");this.clear(),this.append(b),b.render(),_(d).each(function(d){var e=b.charts[d],f=e.barchart.svg;a.addSelectionEvents(f,".bar",c)}),a.addSelectionEvents(b.key.svg,".key-item",c),c.set("selected-jail",""),c.set("selected-jail",e)},addSelectionEvents:function(a,b,c){a.selectAll(b).on("click",function(a){var b=a.jail?a.jail:a;c.set("selected-jail",b)}),c.on("change:selected-jail",function(){var d=c.get("selected-jail");a.selectAll(b).classed("selected",function(a){return a==d||a.jail==d})})},reveal:function(){this.report.reveal()}}),JailCostChart=Backbone.View.extend({className:"jail-cost",titleTemplate:_.template("<h4><%= month.substring(0,3) %></h4>"),initialize:function(a){this.month=a.month,this.model=a.model,this.title=$(this.titleTemplate(a)),this.barchart=new Barchart({id:"chart-"+this.month,className:"barchart",data:this.model.getCostFor(this.month),maxCost:this.model.maxCost,labels:a.labels}),_.bindAll(this)},append:function(a){this.$el.append(a.el),a.parent=this},clear:function(){this.$el.empty()},render:function(){with(this)clear(),title.appendTo($el),append(barchart),barchart.render()}}),JailCostReport=Backbone.View.extend({className:"jail-cost-report",initialize:function(a){this.model=a.model,this.key=new BarKey({data:this.model.get("jails")}),this.charts=this.createMonthCharts(this.model),_.bindAll(this)},append:function(a){this.$el.append(a.el),a.parent=this},prepend:function(a){this.$el.prepend(a.el),a.parent=this},clear:function(){this.$el.empty()},render:function(){var a=this.key,b=this.charts,c=this.model.get("months"),d=this;d.clear(),_(c).each(function(a){d.append(b[a]),b[a].render()}),d.prepend(a),a.render()},hide:function(){this.$el.hide()},reveal:function(){this.$el.find(".key").fadeTo(0,0),this.$el.find(".jail-cost").fadeTo(0,0);var a=0;console.log(this.$el),this.$el.show(),this.$el.find(".jail-cost").each(function(b){a=150*(b+1),$(this).delay(a).fadeTo(750,1)}),this.$el.find(".key").delay(a+150).fadeTo(750,1)},createMonthCharts:function(a){var b={},c=a.get("months"),d=a.get("jails"),e=(a.get("maxCost"),_(d).map(function(a){return a.substring(0,1)}));return _(c).each(function(c){b[c]=new JailCostChart({id:"cost-"+c,month:c,model:a,labels:e})}),b}});